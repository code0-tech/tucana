# frozen_string_literal: true

require "fileutils"

require "bundler/gem_tasks"
require "rspec/core/rake_task"

RSpec::Core::RakeTask.new(:spec)

PROJECT_ROOT = File.expand_path("../..", __dir__)
RUBY_ROOT = "#{PROJECT_ROOT}/build/ruby".freeze
INPUT_INTERNAL_DIR = "#{PROJECT_ROOT}/internal".freeze
OUTPUT_INTERNAL_DIR = "#{RUBY_ROOT}/lib/tucana/internal".freeze

def system!(*args)
  system(*args, exception: true)
end

namespace :generate_ruby do
  desc "Generate ruby files for the internal protocol"
  task :internal do
    FileUtils.rm_rf(OUTPUT_INTERNAL_DIR)
    FileUtils.mkdir_p(OUTPUT_INTERNAL_DIR)
    FileUtils.chdir RUBY_ROOT do
      Dir["#{INPUT_INTERNAL_DIR}/*.proto"].each do |file|
        # rubocop:disable Layout/LineLength
        system!("bundle exec grpc_tools_ruby_protoc -I #{INPUT_INTERNAL_DIR} --ruby_out=#{OUTPUT_INTERNAL_DIR} --grpc_out=#{OUTPUT_INTERNAL_DIR} #{file}")
        # rubocop:enable Layout/LineLength
      end
    end
  end

  desc "Generate ruby files for all protocols"
  task all: ["generate_ruby:internal"]
end

namespace :release do
  desc "Set the version for the gem"
  task :version, [:version] do |_, args|
    File.write("#{RUBY_ROOT}/lib/tucana/version.rb", <<~RUBY)
    # frozen_string_literal: true

    # this file is managed with the "release:version" task.
    # to update the version, run "bundle exec rake release:version[NEW_VERSION]".

    module Tucana
      VERSION = "#{args[:version]}"
    end
    RUBY

    system!("bundle")
  end
end

task default: %i[spec]
